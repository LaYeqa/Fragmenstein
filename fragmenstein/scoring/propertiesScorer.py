#!/usr/bin/env python

"""
Scoring based on properties such as synthetic accessibility
"""
import os
import numpy as np
from collections import OrderedDict

from rdkit import Chem


from fragmenstein.external import ExternalToolImporter
from fragmenstein.external.scscore.SCScoreWrapper import SCScoreWrapper
from fragmenstein.scoring._scorer_base import _ScorerBase

[sascorer] = ExternalToolImporter.import_tool("sascorer", ["sascorer"])
class PropertiesScorer(_ScorerBase):


    def __init__(self, *args, **kwargs):
        '''
        This params are generally provided through the class method computeScoreForMolecules
        args/kwargs must contain working_directory

        '''
        self.sascorer = sascorer
        self.scsw = SCScoreWrapper()
        super().__init__( *args, **kwargs)

    @property
    def fragments_id(self):
        '''
        This is instantiation of abstract attribute
        :return: the list of all fragment ids that have been loaded
        '''
        return None

    def computeScoreOneMolecule(self, mol_id, mol, frag_ids, *args, **kwargs):
        '''
        :param mol_id: an id of the molecule.
        :param mol: a molecule to evaluate
        :param frag_ids: ignored. Included for compatibility reasons
        :return:
        '''
        sascore = self.sascorer.calculateScore(mol)
        scscore =  self.scsw.compute_score(Chem.MolToSmiles(mol))[0]
        descriptors =  Chem.QED.properties(mol)
        ener_decoy_vs_ensemble = self.score_energyPoseVsEnsemble(mol)
        partial_results = {_ScorerBase.MOL_NAME_ID: mol_id, _ScorerBase.SCORE_NAME_TEMPLATE%"SA": sascore,
                           _ScorerBase.SCORE_NAME_TEMPLATE%"aLogP":descriptors.ALOGP,  _ScorerBase.SCORE_NAME_TEMPLATE%"hbondD":descriptors.HBD,
                           _ScorerBase.SCORE_NAME_TEMPLATE%"hbondA":descriptors.HBA, _ScorerBase.SCORE_NAME_TEMPLATE%"polarSurfaceArea":descriptors.PSA,
                           _ScorerBase.SCORE_NAME_TEMPLATE%"rotableBonds":descriptors.ROTB, _ScorerBase.SCORE_NAME_TEMPLATE%"SC":scscore,
                           _ScorerBase.SCORE_NAME_TEMPLATE % "energyPoseVsEnsemble": ener_decoy_vs_ensemble,
                           }
        return partial_results

    @classmethod
    def score_energyPoseVsEnsemble(cls, mol):
        mol_clean = Chem.Mol(mol.ToBinary())

        from rdkit.Chem import AllChem
        import numpy as np

        try:
            mol_energy = AllChem.UFFGetMoleculeForceField(mol).CalcEnergy()

            AllChem.EmbedMultipleConfs(mol_clean, numConfs=100)
            AllChem.MMFFOptimizeMoleculeConfs(mol_clean, numThreads=0)

            energies = []
            for conf in mol_clean.GetConformers():
                energies.append(AllChem.UFFGetMoleculeForceField(mol_clean, confId=conf.GetId()).CalcEnergy())

            mean_energy = np.mean(energies)
            score = (mol_energy - mean_energy) / mean_energy
        except (RuntimeError, ValueError):
            score = np.nan
        return score

    #TODO: Explore geometry intersection to catch mosters: e.g. https://github.com/GouMinghao/Geometry3D ; https://rosettacode.org/wiki/Find_the_intersection_of_a_line_with_a_plane#Python
    @classmethod
    def parseCmd(cls):
        description = "Computes drug-related properties for molecules"
        return _ScorerBase.parseCmd(description)


def test():
    import tempfile
    with tempfile.TemporaryDirectory() as tmp_score:
        ps = PropertiesScorer(working_dir=tmp_score)
        mol = Chem.MolFromSmiles("CC")
        results = ps.computeScoreOneMolecule("one_id", mol, None)
        print( results )




def test2():
    import numpy as np
    from matplotlib import pyplot as plt
    from rdkit.Chem import Draw
    mols=OrderedDict(
    nasty1 = b'\xef\xbe\xad\xde\x00\x00\x00\x00\x0c\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00$\x00\x00\x00&\x00\x00\x00\x80\x01\x06\x00`\x00\x00\x00\x01\x03\x07\x00 \x00\x00\x00\x03\x06\x00`\x00\x00\x00\x02\x02\x06\x004\x00\x00\x00\x01\x01\x04\x10\x00 \x00\x00\x00\x06\x06\x00`\x00\x00\x00\x02\x02\x06\x00`\x00\x00\x00\x02\x02\x08\x00(\x00\x00\x00\x03\x02\x08\x00(\x00\x00\x00\x03\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x00`\x00\x00\x00\x02\x02\x07\x00`\x00\x00\x00\x01\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x00$\x00\x00\x00\x01\x04\x06@(\x00\x00\x00\x03\x04\x06\x00(\x00\x00\x00\x03\x04\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x07\x00h\x00\x00\x00\x03\x02\x01\x08\x00(\x00\x00\x00\x03\x02\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06\x00`\x00\x00\x00\x02\x02\x06@h\x00\x00\x00\x03\x03\x01\x06\x00`\x00\x00\x00\x02\x02\x08\x00 \x00\x00\x00\x02\x06\x00`\x00\x00\x00\x02\x02\x07\x00(\x00\x00\x00\x03\x03\x10\x00$\x00\x00\x00\x01\x06\x08\x00(\x00\x00\x00\x03\x02\x06\x00h\x00\x00\x00\x03\x03\x01\x06\x00h\x00\x00\x00\x03\x03\x01\x06\x00h\x00\x00\x00\x03\x03\x01\x06\x00h\x00\x00\x00\x03\x03\x01\x06\x004\x00\x00\x00\x02\x01\x04\x07\x00`\x00\x00\x00\x01\x02\x0b\x00\x01\x00\x01\x02\x00\x01\x03\x00\x02\x04\x00\x03\x05\x00\x03\x06\x00\x04\x07\x08\x02\x04\x08\x08\x02\x05\t\x00\x06\n\x00\x04\x0b\x00\t\x0c\x00\n\r\x00\x0c\r\x00\r\x0e\x00\r\x0f\x00\x0e\x10h\x0c\x0e\x11h\x0c\x0f\x12 \x0f\x13(\x02\x10\x14h\x0c\x11\x15h\x0c\x12\x16\x00\x14\x17h\x0c\x15\x17h\x0c\x16\x18\x00\x18\x19\x00\x19\x1a\x00\x1a\x1b\x00\x1b\x1c\x08\x02\x1c\x1d\x08\x02\x1c\x1e\x00\x1c\x1f\x00\x1e \x08\x02\x1f!\x08\x02 "\x00!"\x00"#\x00\x14\x03\x07\x03\x05\t\x0c\r\n\x06\x06\x10\x14\x17\x15\x11\x0e\x06\x1e "!\x1f\x1c\x17\x01\x00\x00\x00\x01\x00\x00\x00\x00$\xfc\xa9q\xbf\x00\x80\x17B\xf6(g\xc2B`\xe5<q\xbd\x1bB\x8ble\xc2\xf4\xfd\x94\xbe}?!B\xecQg\xc2H\xe1\xba?\xb2\x9d\x1aB\xa8Fd\xc2\x8d\x97N\xbf\xb8\x9e!B5^n\xc2\xf4\xfd\xd4?\xf6\xa8\x15Bj\xbc`\xc2\xee|\x1f@\xd1\xa2\x1aB\xc9\xf6h\xc2\xbct\x93\xbc=\x8a%B!0q\xc2\xd9\xce\x0f\xc0\\\x8f!BT\xe3n\xc2#\xdb\xd9?\x17Y\x10B\x12\x83b\xc2\xfc\xa9q@7\t\x17B\x9eoh\xc29\xb4\x88\xbe\xb4\xc8\x1bB\x8d\x97p\xc2`\xe58@\x81\x15\x0eB\xd5xd\xc2\x9e\xefW@j<\x11Bshi\xc2\x00\x00\x08@)\xdc\x12B\x10Xl\xc2\x06\x81\x91@\xd7#\x0eB\xfeTl\xc2/\xdd\x0c@\x06\x81\x16B\xe7{p\xc2/\xddd?\n\xd7\x10B3\xb3j\xc2\x02+\x87@\xe1z\nB\x8fBp\xc2\xdb\xf9\xb6@\xa4\xf0\x0eB\x8d\x17k\xc2\xc7K\x87?R8\x18Bs\xe8r\xc2\xcf\xf7\x93\xbeNb\x12B\x85\xebl\xc2\x89A\x94@s\xe8\x04Bo\x12p\xc2\xc3\xf5\xa8\xbe\x93\x18\x16B\x1f\x05q\xc2\x7fj\xc0@\x9a\x99\x04B\n\xd7p\xc2\xaeG\xcd@\xdf\xcf\x05B\xecQu\xc2\x19\x04\xea@f\xe6\x01B\xaeGw\xc2\x7fj\x06A\xa4\xf0\x03B\x93\x98z\xc2\xfe\xd4\x12A\xfc\xa9\xfeA\xd9N}\xc2\x8f\xc2)AT\xe3\xfdA\xa2\xc5|\xc233\x07A\x9a\x99\xf2A\xdd${\xc2\xf2\xd2\rA\xb4\xc8\xfdA\x81\x15\x82\xc2\x9e\xef\x03A\x81\x95\xe9A\x7fj~\xc2\xdd$\nA\xb4\xc8\xf3A\xc1J\x83\xc2\x93\x18\nA\xe9&\xe9As\xe8\x81\xc2\xaa\xf1\xfe@;\xdf\xe1A\xec\x91\x83\xc2\x16',
    nasty2 = b'\xef\xbe\xad\xde\x00\x00\x00\x00\x0c\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00 \x00\x00\x00"\x00\x00\x00\x80\x01\x06\x004\x00\x00\x00\x02\x01\x04\x06\x00`\x00\x00\x00\x02\x02\x06\x004\x00\x00\x00\x01\x01\x04\x06\x004\x00\x00\x00\x01\x01\x04\x08\x00 \x00\x00\x00\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x00`\x00\x00\x00\x01\x03\x10\x00 \x00\x00\x00\x06\x06\x00`\x00\x00\x00\x02\x02\x06\x004\x00\x00\x00\x02\x01\x04\x06@(\x00\x00\x00\x03\x04\x08\x00(\x00\x00\x00\x03\x02\x08\x00(\x00\x00\x00\x03\x02\x06\x00`\x00\x00\x00\x01\x03\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x08\x00 \x00\x00\x00\x02\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06\x00`\x00\x00\x00\x02\x02\x06@h\x00\x00\x00\x03\x03\x01\x06\x00`\x00\x00\x00\x02\x02\x06@(\x00\x00\x00\x03\x04\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@(\x00\x00\x00\x03\x04\x06@h\x00\x00\x00\x03\x03\x01\x07\x00h\x00\x00\x00\x03\x02\x01\x06@h\x00\x00\x00\x03\x03\x01\x10\x00`\x00\x00\x00\x05\x01\x08\x00(\x00\x00\x00\x03\x02\x08\x00(\x00\x00\x00\x03\x02\x0b\x00\x01\x00\x01\x02\x00\x00\x03\x00\x00\x04\x00\x03\x05\x00\x03\x06\x00\x07\x04\x00\x02\x08\x00\x05\t\x00\x08\t\x00\x02\n\x00\x07\x0b\x08\x02\x07\x0c\x08\x02\x07\r\x00\n\x0eh\x0c\n\x0fh\x0c\t\x10\x00\x0e\x11h\x0c\x0f\x12h\x0c\x10\x13\x00\x11\x14h\x0c\x12\x14h\x0c\x13\x15\x00\x15\x16\x00\x16\x17h\x0c\x16\x18h\x0c\x18\x19h\x0c\x17\x1ah\x0c\x19\x1b \x19\x1ch\x0c\x1a\x1ch\x0c\x1b\x1d\x00\x1d\x1e\x08\x02\x1d\x1f\x08\x02\x14\x03\x07\x00\x01\x02\x08\t\x05\x03\x06\x0e\x11\x14\x12\x0f\n\x06\x17\x1a\x1c\x19\x18\x16\x17\x01\x00\x00\x00\x01\x00\x00\x00\x00 \x08\xac\xec?\xc7K\x19B\xf2\xd2g\xc2y\xe9\x16@H\xe1\x15B\xcb!c\xc2\x19\x04\x06@X\xb9\x0fBq=c\xc2\x87\x16!@J\x0c\x18B\x14.m\xc2\xb4\xc8\x06@\x10\xd8\x1eBw\xbef\xc2\xfc\xa9q@\xa6\x9b\x14Bh\x91l\xc2\xf8S\xc3?=\x8a\x15B\xa6\x1bq\xc25^Z?\x7f\xea"B\x17\xd9e\xc2\xd1"K@\x9a\x99\x0cB\x00\x80f\xc2\x98nR@X\xb9\x0eB\x10Xl\xc2m\xe7\x03@V\x8e\x0eBTc]\xc29\xb4H=7\t!B\x85ka\xc2D\x8b\xac?\x10X(B+\x07f\xc2\xe3\xa5\x1b\xbd%\x86!B\x1d\xdak\xc2\xdfOM?h\x11\x10B\xd3\xcd^\xc2\x8f\xc2U@V\x8e\rB%\x06_\xc2\xf2\xd2\x89@\x8bl\x0bBF\xb6n\xc2D\x8bL?=\n\x11B\xd3\xcdd\xc2\x9c\xc4X@\xfa~\x0eBV\x0ee\xc2\xfe\xd4p@\xc3\xf5\x06B\\\x8fq\xc2\xd3M\n@\xbe\x1f\x10B\x0e\xadg\xc2\xc9v\x92@o\x12\x04B\xee\xfct\xc2\x19\x04\xbe@\x1f\x85\x02BJ\x0cs\xc2\x89A\xc4@\x8f\xc2\xfeA\xf4}n\xc2\x08\xac\xe4@\xc3u\x04B^:v\xc2R\xb8\x06A\x8d\x17\x03B\\\x8ft\xc2sh\xed@\x9e\xef\xfbA\xa8\xc6l\xc2\x1b/\x19A\xf8\xd3\x04B\x7fjw\xc2o\x12\tAZd\xffA\xbe\x9fo\xc2\x19\x04\x1eA\xdd\xa4\x01B\xd3M}\xc2=\n1A\xa8\xc6\xfcA\xa2\xc5|\xc2+\x87\x1cA\x83\xc0\x05B\x14\xae\x80\xc2\x16',
    nasty3 = b'\xef\xbe\xad\xde\x00\x00\x00\x00\x0c\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x1b\x00\x00\x00\x1d\x00\x00\x00\x80\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@(\x00\x00\x00\x03\x04\x06@h\x00\x00\x00\x03\x03\x01\x08\x00(\x00\x00\x00\x03\x02\x07\x00`\x00\x00\x00\x02\x01\x06\x00`\x00\x00\x00\x02\x02\x06@(\x00\x00\x00\x03\x04\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@(\x00\x00\x00\x03\x04\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@(\x00\x00\x00\x03\x04\x06@(\x00\x00\x00\x03\x04\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x08\x00(\x00\x00\x00\x03\x02\x06@h\x00\x00\x00\x03\x03\x01\x06\x00`\x00\x00\x00\x02\x02\x07\x00&\x00\x00\x00\x01\x01\x04\x06\x00`\x00\x00\x00\x01\x03\x08\x00"\x00\x00\x00\xff\x01\x08\x00`\x00\x00\x00\x01\x01\x0b\x00\x01h\x0c\x01\x02h\x0c\x00\x03h\x0c\x03\x04h\x0c\x02\x05h\x0c\x04\x05h\x0c\x04\x06 \x06\x07\x00\x07\x08\x00\x08\t\x00\t\nh\x0c\t\x0bh\x0c\n\x0ch\x0c\x0b\rh\x0c\x0c\x0eh\x0c\r\x0eh\x0c\x0c\x0f \x0f\x10h\x0c\x0f\x11h\x0c\x11\x12h\x0c\x10\x13h\x0c\x10\x14 \x12\x15h\x0c\x13\x15h\x0c\x14\x16\x00\x16\x17\x00\x17\x18\x00\x17\x19\x00\x17\x1a\x00\x14\x03\x06\x00\x03\x04\x05\x02\x01\x06\n\x0c\x0e\r\x0b\t\x06\x10\x13\x15\x12\x11\x0f\x17\x01\x00\x00\x00\x01\x00\x00\x00\x00\x1b\xe3\xa5\xf7@#\xdb\x00Bs\xe8z\xc2\x91\xed\x02A\xe9&\xfaA\x9c\xc4v\xc2\x17\xd9\xe6@\xa4p\xf8A5^r\xc2\xd9\xce\xcf@)\\\x03Bu\x93z\xc2\xb6\xf3\xa9@\x14.\x03B\x19\x84v\xc2\xe3\xa5\xbb@\xb4\xc8\xfeA9\xb4r\xc2sh\x8d@5^\x02B\xc3ur\xc2\x9e\xef\x93@7\t\x06B\xbc\xf4m\xc2\x9e\xef\xa3@s\xe8\nB\x1dZp\xc2\xd7\xa3\x94@\xb0\xf2\x0fB\xe3\xa5m\xc2#\xdbQ@\x00\x00\x11B\xaa\xf1l\xc2+\x87\xb2@L\xb7\x13B\x9c\xc4k\xc2\x0c\x023@\x08\xac\x15B\xb6sj\xc2\xc3\xf5\xa4@\xc3u\x18B\x8fBi\xc2\xc3\xf5p@\x9eo\x19B\xa6\x9bh\xc2\x08\xac\xac?\x02\xab\x16B-\xb2i\xc2\xc3\xf5\xc8?\x98\xee\x18Bh\x91n\xc2\x93\x18\xf4?\xee\xfc\x13BJ\x8ce\xc2\xfc\xa9Q@\x93\x18\x13B{\x94f\xc2\x9a\x99A@u\x13\x18BB\xe0o\xc2\xcb\xa1%?\x1f\x85\x1bBL\xb7q\xc2;\xdfw@\x12\x03\x15Bu\x93k\xc2\x81\x95#\xbf\nW\x1bB\x8d\x17o\xc2\x0e-r\xbfL7 B\xcb\xa1k\xc2=\n\xd7=P\r!B\x98ng\xc2\xc7K\x87\xbf\xd1\xa2$Bj\xbcn\xc2\xb6\xf3\r\xc09\xb4\x1fB5\xdeh\xc2\x16',
    ugly = b"\xef\xbe\xad\xde\x00\x00\x00\x00\x0c\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x15\x00\x00\x00\x16\x00\x00\x00\x80\x01\x06\x00`\x00\x00\x00\x01\x03\x06\x00`\x00\x00\x00\x02\x02\x07\x00`\x00\x00\x00\x02\x01\x06\x00`\x00\x00\x00\x02\x02\x08\x00 \x00\x00\x00\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x004\x00\x00\x00\x01\x01\x04\x06\x00`\x00\x00\x00\x02\x02\x06\x004\x00\x00\x00\x02\x01\x04\x06\x00`\x00\x00\x00\x02\x02\x06\x00h\x00\x00\x00\x03\x03\x01\x06\x004\x00\x00\x00\x01\x01\x04\x06\x00(\x00\x00\x00\x03\x04\x10\x00 \x00\x00\x00\x04\x06\x00`\x00\x00\x00\x02\x02\x06\x00h\x00\x00\x00\x03\x03\x01\x06\x00`\x00\x00\x00\x01\x03\x07\x00(\x00\x00\x00\x03\x03\x07\x00(\x00\x00\x00\x03\x03\x06\x00h\x00\x00\x00\x03\x02\x02\x10\x00`\x00\x00\x00\x03\x01\x0b\x00\x01\x00\x01\x02\x00\x02\x03\x00\x03\x04\x00\x04\x05\x00\x05\x06\x00\x06\x07\x00\x06\x08\x00\x07\t\x00\x08\n\x00\x08\x0b\x00\t\x0c\x04\x04\x0b\r\x00\x0b\x0e\x00\n\x0f\x08\x02\x0e\x0f\x00\x0c\x10\x04\x04\r\x11\x04\x04\x0c\x12\n\x02\x03\x02\t\x14\r\x13\x0e\x02\x05\x01\x00\x11\x14\n\x02\x02\x02\r\x12\x12\x14\x04\x04\x14\x02\n\x06\x08\x0b\r\x11\x14\x12\x0c\t\x07\x05\n\x08\x0b\x0e\x0f\x17\x01\x00\x00\x00\x01\x00\x00\x00\x00\x15\x7fj\xb4@\x89\xc1\x03B\xa8\xc6u\xc2\x04V\xb6@h\x11\x05B\x04Vp\xc2B`\x91@\xaaq\x08Bw>o\xc2\xecQ\x8c@\xcfw\tBu\x93i\xc2\xa4p\x8d@\x87\x16\x0fB\x1b\xafh\xc2shQ@\x85\xeb\x10B\x1b\xafe\xc2\x91\xed\xfc?\xb6s\x10B%\x06i\xc2\xee|??!\xb0\x10B\x02\xabe\xc2\xd5x\xf9?\x14.\x13B\xf2\xd2m\xc2B`e>\x9a\x19\x16B\n\xd7c\xc2\xf8S[@7\t\x14B\xee\xfcn\xc233\xc3?\xcb!\x19B\xf2\xd2n\xc2\x93\x18d\xbf\xfeT\x18B5^g\xc2Nb\x10\xbeJ\x8c\x1cB\xd7\xa3n\xc2\x04V\x16@\x10\xd8\x1bB\xdb\xf9j\xc2\xd3MZ@\xf0\xa7\x18B\xf0'm\xc2D\x8b\xac\xbf5\xde\x14B\x06\x81k\xc2\xb0r\xd8\xbf\xa2E\x1aB\\\x0fp\xc2\xf6(\xbc\xbf7\t\x1dB\x81\x15g\xc2\x81\x95\x83\xbe\xecQ#B\x81\x95l\xc2-\xb2%\xc0}?\x1eB\x00\x00l\xc2\x16",
    ok1 =    b'\xef\xbe\xad\xde\x00\x00\x00\x00\x0c\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0f\x00\x00\x00\x0f\x00\x00\x00\x80\x01\x06\x00`\x00\x00\x00\x01\x03\x07\x00&\x00\x00\x00\x01\x01\x04\x08\x00 \x00\x00\x00\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x004\x00\x00\x00\x02\x01\x04\x06\x004\x00\x00\x00\x01\x01\x04\x10\x00$\x00\x00\x00\x02\x04\x08\x00(\x00\x00\x00\x03\x02\x06\x00`\x00\x00\x00\x01\x03\x06\x004\x00\x00\x00\x02\x01\x04\x06\x00`\x00\x00\x00\x02\x02\x06\x00`\x00\x00\x00\x01\x03\x06\x00`\x00\x00\x00\x01\x03\x06\x00`\x00\x00\x00\x01\x03\x0b\x00\x01\x00\x01\x02\x00\x01\x03\x00\x01\x04\x00\x03\x05\x00\x04\x06\x00\x07\x02\x00\x07\x08\x08\x02\x07\t\x00\x05\n\x00\x06\x0b\x00\n\x0b\x00\x05\x0c\x00\x06\r\x00\n\x0e\x00\x14\x01\x07\x01\x03\x05\n\x0b\x06\x04\x17\x01\x00\x00\x00\x01\x00\x00\x00\x00\x0f\xa6\x9b\x94\xbf\xf4\xfd\x13B\xf8\xd3j\xc2!\xb0r\xbe\xd3M\x18B\nWi\xc2\x87\x16\x89\xbfo\x12\x1dB\xf0\xa7g\xc2\x00\x00@?\xa0\x1a\x18B\xb6\xf3d\xc2\xa4p\xbd>s\xe8\x19B\xecQn\xc21\x08\xec?\x9a\x99\x13B#[d\xc2m\xe7\xeb?}\xbf\x18B#[n\xc2\xbct\x1b\xc0}\xbf\x1eB\xe3\xa5j\xc2{\x14\x1e\xc0\xb8\x1e\x1cB^\xbao\xc2\x8bl\xd7\xbf\x19\x04%B#\xdbk\xc2\xcd\xcc4@\x0c\x82\x12BZ\xe4h\xc2\xb0r\x10@u\x13\x13B\x0e\xadm\xc2\x0e-\xa2?\x7fj\x0eB\xcd\xccb\xc2)\\\x17@T\xe3\x19B\x8d\x97s\xc2\xe9&a@V\x0e\rB!\xb0h\xc2\x16',
    big_strage = b'\xef\xbe\xad\xde\x00\x00\x00\x00\x0c\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x1b\x00\x00\x00\x1c\x00\x00\x00\x80\x01\x10\x008\x00\x00\x00\x03\x01\x06\x07\x00(\x00\x00\x00\x03\x03\x07\x00(\x00\x00\x00\x03\x03\x08\x00(\x00\x00\x00\x03\x02\x06\x00`\x00\x00\x00\x01\x03\x10\x00$\x00\x00\x00\x02\x06\x07\x00 \x00\x00\x00\x03\x08\x00(\x00\x00\x00\x03\x02\x06\x00`\x00\x00\x00\x01\x03\x06\x00`\x00\x00\x00\x01\x03\x06\x004\x00\x00\x00\x02\x01\x04\x06\x00`\x00\x00\x00\x02\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x00`\x00\x00\x00\x02\x02\x06\x004\x00\x00\x00\x02\x01\x04\x06\x00(\x00\x00\x00\x03\x04\x08\x00(\x00\x00\x00\x03\x02\x08\x00(\x00\x00\x00\x03\x02\x06\x00`\x00\x00\x00\x02\x02\x06@(\x00\x00\x00\x03\x04\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x06@h\x00\x00\x00\x03\x03\x01\x0b\x00\x01(\x02\x01\x02 \x00\x03\x08\x02\x00\x04\x00\x02\x05(\x02\x05\x06\x00\x05\x07\x08\x02\x05\x08\x00\x06\t\x00\x06\n\x00\n\x0b\x00\n\x0c\x00\x0b\r\x00\x0c\x0e\x00\r\x0f\x00\x0e\x10\x00\x0f\x10\x00\x10\x11\x00\x11\x12(\x02\x11\x13 \x13\x14\x00\x14\x15\x00\x15\x16h\x0c\x15\x17h\x0c\x17\x18h\x0c\x16\x19h\x0c\x18\x1ah\x0c\x19\x1ah\x0c\x14\x02\x07\n\x0b\r\x0f\x10\x0e\x0c\x06\x16\x19\x1a\x18\x17\x15\x17\x01\x00\x00\x00\x01\x00\x00\x00\x00\x1b\x02+g\xbf\x14\xae Bmgo\xc2\x1f\x85\x1b\xc0=\n!B+\x07o\xc2\xf4\xfd<\xc0\x1b/\x1fB\xc9\xf6i\xc2d;\xdf\xbe\xc5 %BNbr\xc2\xbaI\x0c\xbe\xee| B\x06\x01i\xc2\x04V\xee\xbf=\n\x1dB\xa2Ef\xc2\xc1\xca\x81\xbfJ\x8c\x18B\xa6\x9bj\xc2H\xe1\x02\xc0!0\x1aB\xdfOa\xc2\x91\xed|\xbfD\x0b#B3\xb3d\xc2\xf2\xd2\xed\xbf\xb2\x1d\x14B\xc7Kl\xc2H\xe1\xba>\xecQ\x16Bh\x11j\xc2\xf0\xa7f?7\t\x17B\x1f\x05e\xc2u\x93\xa8?\xee|\x17B5\xden\xc2)\\\xbf?\x81\x95\x12Bj\xbcb\xc2j\xbc$@#\xdb\x14B\x81\x95n\xc2\xe3\xa53@+\x07\x11B\x10Xe\xc2`\xe50@\xa2E\x10B\x10Xk\xc2\x19\x04v@q=\rB\xaaql\xc2\xdb\xf9\x9e@\xac\x1c\x0fBP\x8dl\xc2\xd1"c@\x8b\xec\x07B\xa0\x1am\xc2\xe1zl@\x02+\x05B\xfc)r\xc2\x85\xeb\xa1@\x1d\xda\x02Bb\x90r\xc2\x83\xc0\xae@\xd5x\xfeA\x83\xc0n\xc2\xbe\x9f\xbe@\x7fj\x04B\xc3\xf5v\xc2\xa0\x1a\xe7@\xfc)\x02B\x0e-w\xc2\xe3\xa5\xd7@{\x14\xfaA{\x14o\xc2\x1f\x85\xf3@\xdb\xf9\xfcAq=s\xc2\x16',
    )

    for molId in mols:
        mol = Chem.Mol( mols[molId] )
        score = PropertiesScorer.score_energyPoseVsEnsemble(mol)
        print(molId, score)
        if np.isnan(score) or  score >10:
            plt.imshow(Draw.MolsToGridImage([mol], molsPerRow=1))
            plt.show()
            continue

def executeExample():
    fname ="/home/ruben/nsp13Data/nsp13_combined_full.sdf"
    mols = [ (mol.GetProp("_Name"), mol) for mol in Chem.SDMolSupplier(fname) ]
    mols = OrderedDict(mols)

    w = Chem.SDWriter("/home/ruben/nsp13Data/nsp13_combined_cleaned.sdf")

    for molId in mols:
        mol = Chem.Mol( mols[molId] )
        score = PropertiesScorer.score_energyPoseVsEnsemble(mol)
        print(molId, score)
        if np.isnan(score) or  score >10:
            continue
            # plt.imshow(Draw.MolsToGridImage([mol], molsPerRow=1))
            # plt.show(


        mol.SetProp("energyPoseVsEnsemble_score", str(score))
        w.write(mol)


if __name__ == "__main__":
    test2() ; input("done")
    results = PropertiesScorer.evalPipeline(initiaze_parallel_execution=True)
    print(results)


'''
python -m fragmenstein.scoring.propertiesScorer -i /home/ruben/oxford/myProjects/diamondCovid/data/Mpro/compound_vs_fragments.csv -d /home/ruben/oxford/myProjects/diamondCovid/data/Mpro/aligned -f /home/ruben/oxford/myProjects/diamondCovid/data/Mpro/hit_mols  -o compound-set_properties.csv -s  compound-set_properties.sdf  -w ~/tmp/test_dask
'''
